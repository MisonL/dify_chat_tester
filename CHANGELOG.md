# 更新日志

所有重要的项目更改都将记录在此文件中。

格式基于 [Keep a Changelog](https://keepachangelog.com/zh-CN/1.0.0/)，
并且本项目遵循 [语义化版本](https://semver.org/lang/zh-CN/)。

---

## [1.3.2] - 2025-12-05

### 新增

- **统一异常处理**：引入 `exceptions.py` 模块，定义标准化的异常类体系，提供更友好的错误提示信息。
- **配置化批量保存**：新增 `BATCH_SAVE_INTERVAL` 配置项，允许用户自定义批量处理时的自动保存间隔（默认 10 条）。

### 优化

- **架构重构**：
  - **服务层抽离**：将问题生成逻辑抽离为独立的 `QuestionService`，降低控制器耦合度。
  - **依赖注入**：重构 `AppController`，支持外部注入配置和环境管理器，提升可测试性。
- **优雅退出机制**：
  - 在 `main.py` 中添加顶层 `KeyboardInterrupt` 捕获，用户按 `Ctrl+C` 时显示友好提示而非 Traceback。
  - 在批量处理循环中添加中断捕获，确保用户中断操作时自动保存当前处理进度，防止数据丢失。

### 测试

- **覆盖率提升**：新增针对服务层和异常处理模块的单元测试，确保核心逻辑稳健。

## [1.3.1] - 2025-12-04

### 新增

- 新增“AI 生成跨知识点测试提问点”主菜单功能：
  - 主菜单增加选项 3：AI 生成跨知识点测试提问点；
  - 原有生成测试提问点功能更名为“AI 生成单一知识点测试提问点”；
  - 支持从多个文档、多个知识点组合生成跨知识点测试问题。
- 提示词配置增强：
  - 单一知识点和跨知识点的生成提示词均可在 `.env.config` 中单独配置；
  - 支持使用多行三引号格式书写复杂提示词，维护更加方便。

### 优化

- 单一知识点生成逻辑：
  - 不再强制“至少 15-20 个问题”，而是根据知识点数量和用户真实提问概率动态决定问题数量；
  - 对高概率知识点会多生成不同角度的提问，对中低概率知识点做适度覆盖。
- 跨知识点生成逻辑：
  - 提示词从“严格只生成中/高概率场景”调整为“优先高概率，但允许合理的一般场景”，减少全为空结果的情况；
  - 更强调从“真实用户具体场景”角度寻找组合使用方式（流程前后、工具协同、角色协同等）。
- 配置与交互体验：
  - 对 Dify、OpenAI 兼容接口、iFlow 的基础 URL 和 API Key，如果在 `.env.config` 中已配置，交互时会先展示并询问是否直接使用；
  - 在非交互环境（如 pytest、CI）下自动跳过交互确认，直接使用配置值，避免阻塞测试。
- 跨知识点迭代策略：
  - 新增 `CROSS_KNOWLEDGE_MIN_ITERATIONS` 与 `CROSS_KNOWLEDGE_MAX_ITERATIONS` 配置项，控制随机组合轮数下限和上限；
  - 默认最少执行 5 轮、最多 20 轮，可按业务需要调整（例如提升为 50~100 轮以覆盖更多组合）。

### 修复

- 修复配置加载器文档字符串中示例三引号导致的语法/缩进问题，确保在所有 Python 版本下正常导入。

---

## [1.3.0] - 2025-12-02

### 新增

- **智能日志系统**：改进日志目录检测逻辑，自动处理权限问题（优先程序目录，无权限时回退至用户目录）。
- **流式输出优化**：新增 `StreamDisplay` 组件，提供更友好的 AI 思考过程展示（带机器人图标和边框）。
- **Excel 导出增强**：生成的测试问题文件现在包含美化的表头和自动调整的列宽。
- **测试增强**：全面提升单元测试覆盖率，新增 `selectors`、`terminal_ui` 和 `question_generator` 模块的测试用例。
- **UI 优化**：改进 API 密钥隐藏逻辑，优化输入提示交互。
- **AI 提示词自定义** (新功能)：
  - 支持通过 `.env.config` 配置文件自定义系统提示词
  - 新增 `SYSTEM_PROMPT` 配置项
  - 支持 `{role}` 占位符替换
  - 用户可调整 AI 对话风格和行为（专业领域/回答风格/多语言）
  - 详细配置文档：`AI_PROMPT_CONFIG.md`

### 优化

- **配置管理重构**：统一供应商设置模块 (`provider_setup.py`) 的配置读取逻辑。
- **问题解析优化**：增强 `question_generator` 的问题提取算法，支持识别带编号/列表形式的问题，只保留以问号结尾或原本为列表项的行，提升生成问题的准确性和稳定性。
- **测试覆盖率再提升**：在 `ai_providers`、`app_controller`、`config_loader`、`terminal_ui`、`batch_manager`、`chat_manager`、`console_platform` 等模块补充大量单元测试用例，覆盖更多异常分支和回退逻辑。
- **代码规范**：引入 `isort` 进行导入排序，统一代码格式。
- **文档完善**：大幅更新《用户使用指南》，补充了详细的环境准备、安装步骤和多种运行方式说明。

## [1.2.0] - 2025-12-01

### 新增

- 新增“AI 生成测试提问点”功能：支持读取指定目录下的 Markdown 文档，自动生成测试问题并导出为 Excel 文件。
- 完善了单元测试覆盖率。

### 修复

- 修复了 Dify 供应商识别逻辑，现在使用唯一 ID 而不是显示名称进行判断，解决了自定义名称导致多轮对话失效的问题。
- 修复了代码中的未使用的变量和导入，提升代码质量。
- 优化了终端 UI 的面板宽度一致性。

## [1.1.0] - 2025-11-21

### 新增

- 批量查询模式默认显示响应内容（Y/n）
- k2sonnet API 特殊支持和自动流式检测
- 流式响应失败自动回退机制

### 优化

- Dify 渠道实现真正的流式输出
- 改进流式响应解析，支持实时显示
- 增加请求超时时间到 60 秒
- 优化错误处理和异常信息

### 修复

- 修复 Dify 应用 ID 传递方式（通过 inputs 参数）
- 修复 OpenAI 兼容接口的流式处理问题
- 修复 iFlow 渠道的响应解析逻辑
- 修复代码质量问题（清理未使用导入）

### 清理

- 删除所有测试文件和调试文件
- 清理缓存目录和构建产物
- 优化项目结构，只保留核心文件

## [1.0.0] - 2025-11-14

### 新增

- 支持多 AI 供应商（Dify、OpenAI 兼容接口、iFlow）
- 会话模式：实时多轮对话，自动维护上下文
- 批量询问模式：从 Excel 文件批量处理问题
- 自动创建配置文件功能
- 跨平台打包支持（Windows 和 macOS）
- 完整的中文用户指南

### 功能特性

- AI 等待动画显示优化，避免信息截断
- 支持自定义角色和模型
- Excel 日志记录，包含时间戳、对话轮次等信息
- 批量请求间隔可配置
- 支持流式和非流式响应

### 技术改进

- 使用 uv 包管理器管理依赖
- PyInstaller 打包，生成独立可执行文件
- 智能配置文件路径检测（开发环境/打包环境）
- 完善的.gitignore 配置

### 文档

- 详细的用户使用指南
- 完整的 API 配置说明
- 故障排除指南

---

## 版本说明

- **主版本号**：不兼容的 API 修改
- **次版本号**：向下兼容的功能性新增
- **修订号**：向下兼容的问题修正
